const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');
const packageJson = require('./package.json');
const AdmZip = require('adm-zip');

console.log('üöÄ Startar SFX-byggl√∂sning f√∂r ScreammPDF...');

// S√∂kv√§gar
const distDir = path.join(__dirname, 'dist');
const portableDir = path.join(distDir, 'portable');
const electronDir = path.join(distDir, 'electron');
const releasePath = path.join(distDir, 'release');
const appVersion = packageJson.version;
const sfxOutputFile = path.join(releasePath, `ScreammPDF_${appVersion}_Portable.exe`);

// Skapa mappar
if (!fs.existsSync(distDir)) {
  fs.mkdirSync(distDir, { recursive: true });
}

if (!fs.existsSync(portableDir)) {
  fs.mkdirSync(portableDir, { recursive: true });
} else {
  // Rensa mappen innan
  console.log('üßπ Rensar tidigare byggfiler...');
  fs.readdirSync(portableDir).forEach(file => {
    const filePath = path.join(portableDir, file);
    if (fs.lstatSync(filePath).isDirectory()) {
      fs.rmSync(filePath, { recursive: true, force: true });
    } else {
      fs.unlinkSync(filePath);
    }
  });
}

if (!fs.existsSync(electronDir)) {
  fs.mkdirSync(electronDir, { recursive: true });
}

if (!fs.existsSync(releasePath)) {
  fs.mkdirSync(releasePath, { recursive: true });
}

try {
  // H√§mta Electron
  console.log('üì• Laddar ner och packar upp Electron...');
  const electronVersion = '29.4.6';
  const platform = 'win32';
  const arch = 'x64';
  
  // H√§mta electron fr√•n cache eller ladda ner det
  const cacheDir = path.join(require('os').homedir(), 'AppData', 'Local', 'electron', 'Cache');
  const zipFilename = `electron-v${electronVersion}-${platform}-${arch}.zip`;
  const zipPath = path.join(cacheDir, zipFilename);
  
  if (!fs.existsSync(zipPath)) {
    // Ladda ner om det inte finns i cachen
    execSync(`npx electron-download --platform=${platform} --arch=${arch} --version=${electronVersion}`, {
      stdio: 'inherit'
    });
  }
  
  if (fs.existsSync(zipPath)) {
    console.log(`üîÑ Packar upp Electron...`);
    try {
      const zip = new AdmZip(zipPath);
      zip.extractAllTo(electronDir, true);
      console.log('‚úÖ Electron uppackad!');
      
      // Byt namn p√• electron.exe till ScreammPDF.exe
      console.log('‚úèÔ∏è Byter namn p√• k√∂rbar fil till ScreammPDF.exe...');
      const electronExePath = path.join(electronDir, 'electron.exe');
      const renamePath = path.join(electronDir, 'ScreammPDF.exe');
      if (fs.existsSync(electronExePath)) {
        fs.renameSync(electronExePath, renamePath);
      } else {
        console.warn('‚ö†Ô∏è Kunde inte hitta electron.exe f√∂r namnbyte');
      }
      
    } catch (err) {
      console.error('‚ùå Kunde inte packa upp Electron med adm-zip, provar PowerShell...');
      try {
        const psCommand = `Expand-Archive -Path "${zipPath}" -DestinationPath "${electronDir}" -Force`;
        execSync(`powershell -Command "${psCommand}"`, { stdio: 'inherit' });
        console.log('‚úÖ Electron uppackad via PowerShell!');
      } catch (psErr) {
        console.error('‚ùå Kunde inte packa upp Electron!');
        throw new Error('Kunde inte packa upp Electron-filen');
      }
    }
  } else {
    console.error(`‚ùå Kunde inte hitta ${zipPath}`);
    throw new Error('Electron zip-filen hittades inte');
  }

  // Kopiera applikationsfiler
  console.log('üìÇ Kopierar applikationsfiler...');
  const filesToCopy = [
    'index.html',
    'main.js',
    'renderer.js',
    'preload.js',
    'package.json'
  ];

  filesToCopy.forEach(file => {
    if (fs.existsSync(file)) {
      fs.copyFileSync(file, path.join(portableDir, file));
    }
  });

  // Kopiera node_modules
  console.log('üìö Kopierar n√∂dv√§ndiga bibliotek...');
  try {
    execSync('npm install --production --ignore-scripts', { stdio: 'inherit' });
  } catch (err) {
    console.warn('‚ö†Ô∏è Vissa beroenden kunde inte installeras, forts√§tter √§nd√•...');
  }
  
  if (fs.existsSync('node_modules')) {
    const targetNodeModules = path.join(portableDir, 'node_modules');
    if (!fs.existsSync(targetNodeModules)) {
      fs.mkdirSync(targetNodeModules, { recursive: true });
    }
    
    // Kopiera bara n√∂dv√§ndiga node_modules-paket
    const dependencies = Object.keys(packageJson.dependencies || {});
    dependencies.forEach(dep => {
      const depPath = path.join('node_modules', dep);
      const targetPath = path.join(targetNodeModules, dep);
      
      if (fs.existsSync(depPath) && fs.lstatSync(depPath).isDirectory()) {
        copyFolderSync(depPath, targetPath);
      }
    });
  }

  // Skapa startfil
  console.log('üìù Skapar startfil...');
  fs.writeFileSync(
    path.join(portableDir, 'start.bat'),
    `@echo off\r\necho Startar ScreammPDF...\r\n.\\..\\electron\\ScreammPDF.exe "%~dp0"\r\n`
  );
  
  // Skapa en README-fil f√∂r portabel version
  fs.writeFileSync(
    path.join(portableDir, 'README.txt'),
    `ScreammPDF Portabel Version ${appVersion}
==============================

Tack f√∂r att du anv√§nder ScreammPDF! Detta √§r den portabla versionen som inte kr√§ver installation.

F√∂r att starta programmet:
1. Klicka p√• start.bat i denna mapp
2. Eller k√∂r ScreammPDF.bat i huvudmappen

Obs: Beh√•ll mapphierarkin intakt f√∂r att programmet ska fungera korrekt.

Copyrght ¬© 2025 ScreammPDF
`
  );

  console.log('üì¶ Skapar sj√§lv-extraherande arkiv...');
  
  try {
    // F√∂rs√∂k hitta 7-Zip
    let sevenZipPath = '';
    const possiblePaths = [
      'C:\\Program Files\\7-Zip\\7z.exe',
      'C:\\Program Files (x86)\\7-Zip\\7z.exe'
    ];
    
    for (const path of possiblePaths) {
      if (fs.existsSync(path)) {
        sevenZipPath = path;
        break;
      }
    }
    
    if (sevenZipPath) {
      console.log('‚úÖ 7-Zip hittades:', sevenZipPath);
      
      // Skapa konfigurationsfiler f√∂r SFX
      const sfxConfigPath = path.join(distDir, 'sfx_config.txt');
      fs.writeFileSync(sfxConfigPath, 
        `;!@Install@!UTF-8!
Title="ScreammPDF ${appVersion} Portabel"
BeginPrompt="Vill du packa upp och starta ScreammPDF?"
Progress="ja"
RunProgram="start.bat"
;!@InstallEnd@!`
      );
      
      // Skapa tempor√§r zip-fil
      const tempZipPath = path.join(distDir, 'temp.zip');
      console.log('üì¶ Skapar zip-fil av applikationen...');
      
      // Anv√§nda adm-zip f√∂r att skapa zip
      const tempZip = new AdmZip();
      addFolderToZip(tempZip, portableDir, '');
      addFolderToZip(tempZip, electronDir, 'electron');
      tempZip.writeZip(tempZipPath);
      
      // Skapa SFX med 7-Zip
      console.log('üîß Skapar sj√§lv-extraherande EXE...');
      const sfxStub = path.join(__dirname, 'resources', '7zSD.sfx');
      
      if (!fs.existsSync(sfxStub)) {
        // Ladda ner SFX stub om den inte finns
        console.log('üì• Laddar ner SFX-stub...');
        fs.mkdirSync(path.join(__dirname, 'resources'), { recursive: true });
        execSync(`"${sevenZipPath}" x -o"${path.join(__dirname, 'resources')}" "${sevenZipPath.replace('7z.exe', '7z.sfx')}"`, 
          { stdio: 'inherit' });
      }
      
      if (fs.existsSync(sfxStub)) {
        // Kombinera SFX, config och zip f√∂r att skapa sj√§lv-extraherande exe
        const allData = Buffer.concat([
          fs.readFileSync(sfxStub),
          fs.readFileSync(sfxConfigPath),
          fs.readFileSync(tempZipPath)
        ]);
        
        fs.writeFileSync(sfxOutputFile, allData);
        console.log(`‚úÖ Sj√§lv-extraherande EXE skapad: ${sfxOutputFile}`);
        
        // Ta bort tempor√§ra filer
        fs.unlinkSync(tempZipPath);
        fs.unlinkSync(sfxConfigPath);
      } else {
        throw new Error('Kunde inte hitta eller skapa SFX-stub');
      }
    } else {
      throw new Error('7-Zip hittades inte p√• systemet');
    }
  } catch (sfxError) {
    console.error('‚ö†Ô∏è Kunde inte skapa sj√§lv-extraherande arkiv:', sfxError.message);
    console.log('üì¶ Skapar vanlig zip-fil ist√§llet...');
    
    // Fallback: Skapa vanlig zip-fil med adm-zip
    const zipOutputFile = path.join(releasePath, `ScreammPDF_${appVersion}_Portable.zip`);
    const appZip = new AdmZip();
    
    addFolderToZip(appZip, portableDir, 'ScreammPDF');
    addFolderToZip(appZip, electronDir, 'ScreammPDF/electron');
    
    // Skapa startfil f√∂r huvudmappen
    const tempDir = path.join(distDir, 'temp');
    if (!fs.existsSync(tempDir)) {
      fs.mkdirSync(tempDir, { recursive: true });
    }
    
    fs.writeFileSync(
      path.join(tempDir, 'ScreammPDF.bat'),
      `@echo off\r\ncd "%~dp0\\ScreammPDF"\r\necho Startar ScreammPDF...\r\n.\\electron\\ScreammPDF.exe "%~dp0\\ScreammPDF"\r\n`
    );
    
    fs.writeFileSync(
      path.join(tempDir, 'README.txt'),
      `ScreammPDF Portabel Version ${appVersion}
==============================

Tack f√∂r att du anv√§nder ScreammPDF! Detta √§r den portabla versionen som inte kr√§ver installation.

Instruktioner:
1. Packa upp hela ZIP-arkivet till valfri plats p√• din dator
2. K√∂r ScreammPDF.bat f√∂r att starta programmet

Obs: Beh√•ll mapphierarkin intakt f√∂r att programmet ska fungera korrekt.

Copyright ¬© 2025 ScreammPDF
`
    );
    
    // L√§gg till filerna i roten av zip-filen
    appZip.addLocalFile(path.join(tempDir, 'ScreammPDF.bat'));
    appZip.addLocalFile(path.join(tempDir, 'README.txt'));
    
    // Spara zip-filen
    appZip.writeZip(zipOutputFile);
    console.log(`‚úÖ Portabel ZIP-fil skapad: ${zipOutputFile}`);
    
    // Ta bort tempor√§r mapp
    fs.rmSync(tempDir, { recursive: true, force: true });
  }

  console.log('‚úÖ Byggnation slutf√∂rd!');
  console.log(`üìÑ Distributionspaket finns i: ${releasePath}`);
} catch (error) {
  console.error('‚ùå Ett fel uppstod under byggnation:');
  console.error(error);
  process.exit(1);
}

// Hj√§lpfunktion f√∂r rekursiv kopiering utan symlinks
function copyFolderSync(source, target) {
  if (!fs.existsSync(target)) {
    fs.mkdirSync(target, { recursive: true });
  }

  const files = fs.readdirSync(source);
  
  files.forEach(file => {
    const sourcePath = path.join(source, file);
    const targetPath = path.join(target, file);
    
    const stats = fs.lstatSync(sourcePath);
    
    if (stats.isFile()) {
      fs.copyFileSync(sourcePath, targetPath);
    } else if (stats.isDirectory()) {
      copyFolderSync(sourcePath, targetPath);
    }
    // Ignorera symlinks helt
  });
}

// Hj√§lpfunktion f√∂r att l√§gga till en hel mapp i en zip-fil med relativa s√∂kv√§gar
function addFolderToZip(zipFile, folderPath, zipPath) {
  const files = fs.readdirSync(folderPath);
  
  files.forEach(file => {
    const filePath = path.join(folderPath, file);
    const entryPath = zipPath ? path.join(zipPath, file) : file;
    
    const stats = fs.lstatSync(filePath);
    
    if (stats.isFile()) {
      zipFile.addLocalFile(filePath, path.dirname(entryPath));
    } else if (stats.isDirectory()) {
      addFolderToZip(zipFile, filePath, entryPath);
    }
  });
} 